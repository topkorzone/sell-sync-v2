name: Deploy Backend

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x backend/gradlew

      - name: Build JAR
        run: |
          cd backend
          ./gradlew :mh-api:bootJar -x test

      - name: Find JAR file
        id: find-jar
        run: |
          JAR_PATH=$(find backend/mh-api/build/libs -name "*.jar" ! -name "*-plain.jar" | head -1)
          echo "jar_path=$JAR_PATH" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR_PATH"

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to Server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SSH_USER: ubuntu
        run: |
          # Upload JAR
          scp -i ~/.ssh/deploy_key ${{ steps.find-jar.outputs.jar_path }} $SSH_USER@$SERVER_IP:/opt/sellsync/app.jar.new

          # Deploy: backup, replace, restart
          ssh -i ~/.ssh/deploy_key $SSH_USER@$SERVER_IP 'cd /opt/sellsync && cp -f app.jar app.jar.backup 2>/dev/null || true && mv app.jar.new app.jar && sudo systemctl restart sellsync'

          # Wait for Spring Boot startup
          echo "Waiting 40s for Spring Boot to start..."
          sleep 40

          # Health check from GitHub Actions runner
          for i in 1 2 3 4 5 6; do
            if curl -sf --connect-timeout 10 http://$SERVER_IP/actuator/health > /dev/null 2>&1; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Retry health check ($i/6)..."
            sleep 10
          done

          echo "Health check failed"
          exit 1

      - name: Deployment Success
        if: success()
        run: echo "Deployment completed successfully!"

      - name: Rollback on Failure
        if: failure()
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SSH_USER: ubuntu
        run: |
          ssh -i ~/.ssh/deploy_key $SSH_USER@$SERVER_IP << 'ENDSSH'
            cd /opt/sellsync
            if [ -f app.jar.backup ]; then
              echo "Rolling back to previous version..."
              mv app.jar.backup app.jar
              sudo systemctl restart sellsync
            fi
          ENDSSH
