name: Deploy Backend

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x backend/gradlew

      - name: Build JAR
        run: |
          cd backend
          ./gradlew :mh-api:bootJar -x test

      - name: Find JAR file
        id: find-jar
        run: |
          JAR_PATH=$(find backend/mh-api/build/libs -name "*.jar" ! -name "*-plain.jar" | head -1)
          echo "jar_path=$JAR_PATH" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR_PATH"

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to Server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SSH_USER: ubuntu
        run: |
          # Upload JAR
          scp -i ~/.ssh/deploy_key ${{ steps.find-jar.outputs.jar_path }} $SSH_USER@$SERVER_IP:/opt/sellsync/app.jar.new

          # Execute deployment
          ssh -i ~/.ssh/deploy_key $SSH_USER@$SERVER_IP << 'ENDSSH'
            set -e
            cd /opt/sellsync

            # Backup current jar
            if [ -f app.jar ]; then
              cp app.jar app.jar.backup
            fi

            # Replace with new jar
            mv app.jar.new app.jar

            # Restart application
            sudo systemctl restart sellsync

            # Wait for application to start (Spring Boot takes ~30s)
            echo "Waiting for application to start..."
            sleep 30

            # Health check with retries
            for i in {1..10}; do
              if curl -sf http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "Health check passed!"
                exit 0
              fi
              echo "Waiting for application... ($i/10)"
              sleep 10
            done

            echo "Health check failed!"
            sudo journalctl -u sellsync -n 50 --no-pager
            exit 1
          ENDSSH

      - name: Deployment Success
        if: success()
        run: echo "Deployment completed successfully!"

      - name: Rollback on Failure
        if: failure()
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SSH_USER: ubuntu
        run: |
          ssh -i ~/.ssh/deploy_key $SSH_USER@$SERVER_IP << 'ENDSSH'
            cd /opt/sellsync
            if [ -f app.jar.backup ]; then
              echo "Rolling back to previous version..."
              mv app.jar.backup app.jar
              sudo systemctl restart sellsync
            fi
          ENDSSH
